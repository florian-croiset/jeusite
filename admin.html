<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Echo Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <style>

        .form-section {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.form-section:last-of-type {
    border-bottom: none;
}

.form-section h4 {
    display: flex;
    align-items: center;
    gap: 8px;
}
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --cyan: #00ffff;
            --cyan-glow: rgba(0, 255, 255, 0.3);
            --purple: #9d00ff;
            --purple-glow: rgba(157, 0, 255, 0.3);
            --dark: #0a0a0f;
            --dark-lighter: #1a1a2e;
            --dark-card: #16213e;
            --success: #00ff88;
            --danger: #ff0055;
            --warning: #ffaa00;
            --text: #e0e0e0;
            --text-dim: #b0b0b0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, #0f0f1e 100%);
            color: var(--text);
            min-height: 100vh;
        }

        /* AUTHENTICATION */
        #auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-box {
            background: var(--dark-card);
            padding: 40px;
            border-radius: 16px;
            border: 2px solid var(--cyan);
            box-shadow: 0 0 40px var(--cyan-glow), inset 0 0 20px rgba(0, 255, 255, 0.1);
            max-width: 400px;
            width: 100%;
            backdrop-filter: blur(10px);
        }

        .auth-box h2 {
            color: var(--cyan);
            margin-bottom: 30px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-size: 24px;
            text-shadow: 0 0 10px var(--cyan-glow);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--cyan);
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--purple);
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--cyan);
            box-shadow: 0 0 15px var(--cyan-glow);
        }

        .btn {
            /*padding: 12px 24px;*/
            padding: 8px 12px;
            background: linear-gradient(135deg, var(--cyan), var(--purple));
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px; /* 16 */
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--cyan-glow);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--cyan), #0088ff);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #00cc66);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #cc0044);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ff8800);
        }

        .error-message {
            background: var(--danger);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            animation: shake 0.5s;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        /* DASHBOARD */
        #dashboard {
            display: none;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--dark-card) 0%, #1a1a3e 100%);
            padding: 20px 40px;
            border-bottom: 2px solid var(--cyan);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .dashboard-header h1 {
            color: var(--cyan);
            font-size: 28px;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 15px var(--cyan-glow);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .user-info span {
            color: var(--purple);
            font-weight: 500;
        }

        .role-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .role-admin {
            background: var(--danger);
            color: white;
            box-shadow: 0 0 15px rgba(255, 0, 85, 0.5);
        }

        .role-collaborator {
            background: var(--warning);
            color: var(--dark);
            box-shadow: 0 0 15px rgba(255, 170, 0, 0.5);
        }

        .dashboard-content {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, var(--dark-card) 0%, var(--dark-lighter) 100%);
            border-right: 2px solid var(--purple);
            padding: 20px;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
        }

        .sidebar-item {
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--purple);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text);
            text-align: center;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        .sidebar-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--cyan-glow), transparent);
            transition: left 0.5s;
        }

        .sidebar-item:hover::before {
            left: 100%;
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            background: linear-gradient(135deg, var(--cyan), var(--purple));
            transform: translateX(5px);
            box-shadow: 0 4px 15px var(--purple-glow);
        }

        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: linear-gradient(135deg, rgba(10, 10, 15, 0.95) 0%, rgba(15, 15, 30, 0.95) 100%);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: var(--dark-card);
            border: 2px solid var(--cyan);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .card h2 {
            color: var(--cyan);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 24px;
            text-shadow: 0 0 10px var(--cyan-glow);
        }

        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--dark-card), var(--dark-lighter));
            padding: 25px;
            border-radius: 12px;
            border: 2px solid var(--purple);
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, var(--cyan-glow) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--cyan);
            box-shadow: 0 10px 30px var(--cyan-glow);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-value {
            font-size: 42px;
            font-weight: bold;
            color: var(--cyan);
            /*margin: 10px 0;*/
            text-shadow: 0 0 15px var(--cyan-glow);
            position: relative;
        }

        .stat-label {
            color: var(--purple);
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 2px;
            position: relative;
        }

        /* TABLES */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 9px; /* 15 */
            text-align: left;
            border-bottom: 1px solid rgba(157, 0, 255, 0.3);
            font-size: 13px;
        }

        th {
            background: rgba(0, 0, 0, 0.5);
            color: var(--cyan);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 12px;/* 13 */
            letter-spacing: 1px;
        }

        tr {
            transition: all 0.3s;
        }

        tr:hover {
            background: rgba(157, 0, 255, 0.1);
            transform: scale(1.01);
        }

        /* ACTION BUTTONS */
        .action-btn {
            padding: 8px 14px;
            margin: 0 4px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 13px;
        }

        .btn-edit {
            background: var(--cyan);
            color: var(--dark);
        }

        .btn-delete {
            background: var(--danger);
            color: white;
        }

        .btn-publish {
            background: var(--success);
            color: var(--dark);
        }

        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: var(--dark-card);
            border: 2px solid var(--cyan);
            padding: 30px;
            width: 600px;
            max-width: 90%;
            border-radius: 16px;
            box-shadow: 0 0 50px var(--cyan-glow);
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--purple);
            padding-bottom: 15px;
        }

        .modal-header h3 {
            color: var(--cyan);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 20px;
        }

                .version-down h3 {
            color: var(--cyan);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 20px;
        }
        .close-modal {
            cursor: pointer;
            font-size: 28px;
            color: var(--danger);
            transition: all 0.3s;
        }

        .close-modal:hover {
            transform: rotate(90deg);
            color: var(--cyan);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* VERSION SPECIFIC */
        .version-header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            /*gap: 15px;*/
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .version-number {
            color: var(--cyan);
            font-weight: bold;
            font-size: 16px;
        }

        .version-type-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .type-alpha {
            background: var(--warning);
            color: var(--dark);
        }

        .type-beta {
            background: var(--purple);
            color: white;
        }

        .type-release {
            background: var(--success);
            color: var(--dark);
        }

        .type-patch {
            background: var(--cyan);
            color: var(--dark);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-active {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-inactive {
            background: rgba(255, 0, 85, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--cyan);
            font-size: 18px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .dashboard-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid var(--purple);
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .version-header-actions {
                flex-direction: column;
                align-items: flex-start;
            }
        }









        .download-controls {
    display: grid;
    gap: 20px;
    margin-top: 20px;
}

.control-item {
    background: rgba(0, 0, 0, 0.3);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--purple);
}

.switch-label {
    display: flex;
    align-items: center;
    gap: 15px;
    cursor: pointer;
}

.switch-label input[type="checkbox"] {
    position: relative;
    width: 60px;
    height: 30px;
    appearance: none;
    background: var(--danger);
    border-radius: 30px;
    transition: all 0.3s;
    cursor: pointer;
}

.switch-label input[type="checkbox"]:checked {
    background: var(--success);
}

.switch-label input[type="checkbox"]::before {
    content: '';
    position: absolute;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: white;
    top: 2px;
    left: 2px;
    transition: all 0.3s;
}

.switch-label input[type="checkbox"]:checked::before {
    left: 32px;
}

.control-text {
    font-size: 16px;
    font-weight: bold;
    color: var(--cyan);
}
    </style>
<!-- Vercel Web Analytics -->
<script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
</head>

<body>
    <!-- Section Authentification -->
    <div id="auth-container">
        <div class="auth-box">
            <h2>üîê Admin Echo</h2>
            <div id="error-container"></div>
            <form id="login-form">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" required placeholder="admin@echo.com">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn" style="font-size: 16px; padding: 12px 24px; width: 100%;">Connexion</button>
            </form>
        </div>
    </div>

    <!-- Dashboard Admin -->
    <div id="dashboard">
        <div class="dashboard-header">
            <h1>‚ö° Echo Dashboard</h1>
            <div class="user-info">
                <span id="user-email"></span>
                <span id="user-role-badge" class="role-badge"></span>
                <button class="btn btn-small btn-danger" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <div class="dashboard-content">
            <div class="sidebar" id="sidebar">
                <div class="sidebar-item active" data-section="overview" style="position: fixed; top: 100px;">üìä Vue d'ensemble</div>
<div class="sidebar-item" data-section="versions" style="position: fixed; top: 175px;">üéÆ Versions du jeu</div>
<div class="sidebar-item" data-section="roadmap" style="position: fixed; top: 250px;">üó∫Ô∏è Roadmap</div>
<div class="sidebar-item" data-section="downloads-manage" style="position: fixed; top: 325px;">üì• T√©l√©chargements</div>
<div class="sidebar-item" data-section="content" style="position: fixed; top: 400px;">üìù Contenu du site</div>
<div class="sidebar-item" data-section="media" style="position: fixed; top: 475px;">üé® M√©dias</div>
<div class="sidebar-item" data-section="forms" style="position: fixed; top: 550px;">üìã Formulaires</div>
<div class="sidebar-item" data-section="notifications" style="position: fixed; top: 625px;">üì¢ Notifications</div>
<div class="sidebar-item" data-section="users" style="position: fixed; top: 700px;">üë• Utilisateurs</div>
<div class="sidebar-item" data-section="site-settings" style="position: fixed; top: 775px;">‚öôÔ∏è Param√®tres</div>
            </div>

            <div class="main-content">
                <!-- Vue d'ensemble -->
                <div class="section active" id="overview">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Utilisateurs</div>
                            <div class="stat-value" id="stats-users">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">M√©dias</div>
                            <div class="stat-value" id="stats-media">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Contenus</div>
                            <div class="stat-value" id="stats-content">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">R√©ponses</div>
                            <div class="stat-value" id="stats-responses">-</div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>Derni√®res activit√©s</h2>
                        <div id="recent-activity">
                            <p class="loading">Chargement</p>
                        </div>
                    </div>
                </div>
                <div class="section" id="notifications">
                    <div class="card">
                        <h2>üì¢ Envoyer une notification</h2>

                        <form id="notification-form" style="max-width: 800px;">
                            <div class="form-group">
                                <label>Type de notification *</label>
                                <select id="notif-type" required>
                                    <option value="info">‚ÑπÔ∏è Information</option>
                                    <option value="success">‚úÖ Succ√®s</option>
                                    <option value="warning">‚ö†Ô∏è Alerte</option>
                                    <option value="danger">üö® Urgent</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Titre *</label>
                                <input type="text" id="notif-title" required
                                    placeholder="Ex: Nouvelle version disponible">
                            </div>

                            <div class="form-group">
                                <label>Message *</label>
                                <textarea id="notif-message" rows="4" required
                                    placeholder="Contenu de la notification..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>Destinataire</label>
                                <select id="notif-recipient-type">
                                    <option value="all">üåç Tous les utilisateurs (Global)</option>
                                    <option value="specific">üë§ Utilisateur sp√©cifique</option>
                                    <option value="role">üë• Par r√¥le</option>
                                </select>
                            </div>

                            <div class="form-group" id="recipient-select-group" style="display: none;">
                                <label>S√©lectionner l'utilisateur</label>
                                <select id="notif-recipient-user">
                                    <option value="">Chargement...</option>
                                </select>
                            </div>

                            <div class="form-group" id="role-select-group" style="display: none;">
                                <label>S√©lectionner le r√¥le</label>
                                <select id="notif-recipient-role">
                                    <option value="user">üë§ Utilisateurs</option>
                                    <option value="collaborator">ü§ù Collaborateurs</option>
                                    <option value="admin">üëë Administrateurs</option>
                                </select>
                            </div>

                            <div class="checkbox-group">
                                <input type="checkbox" id="notif-link">
                                <label for="notif-link">Ajouter un lien d'action</label>
                            </div>

                            <div class="form-group" id="link-group" style="display: none;">
                                <label>URL du lien</label>
                                <input type="url" id="notif-action-url" placeholder="https://...">
                            </div>

                            <div class="checkbox-group">
                                <input type="checkbox" id="notif-persistent">
                                <label for="notif-persistent">Notification persistante (ne s'auto-supprime pas)</label>
                            </div>

                            <div class="form-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-success">
                                    <i class="fa-solid fa-paper-plane"></i> Envoyer
                                </button>
                                <button type="button" class="btn btn-warning" onclick="testNotificationPreview()">
                                    <i class="fa-solid fa-eye"></i> Aper√ßu
                                </button>
                                <button type="reset" class="btn btn-danger">
                                    <i class="fa-solid fa-times"></i> Annuler
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="card">
                        <h2>üìä Historique des notifications</h2>
                        <div id="notifications-history">
                            <p class="loading">Chargement...</p>
                        </div>
                    </div>

                    <div class="card">
                        <h2>üìà Statistiques</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Envoy√©es aujourd'hui</div>
                                <div class="stat-value" id="stats-today">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total envoy√©es</div>
                                <div class="stat-value" id="stats-total">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Taux de lecture</div>
                                <div class="stat-value" id="stats-read-rate">0%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Non lues</div>
                                <div class="stat-value" id="stats-unread">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                                <style>
                                    /* Style rapide pour le switch si pas d√©j√† pr√©sent */
                                    input:checked+.slider {
                                        background-color: var(--cyan);
                                    }

                                    input:checked+.slider:before {
                                        transform: translateX(26px);
                                    }

                                    .slider:before {
                                        position: absolute;
                                        content: "";
                                        height: 16px;
                                        width: 16px;
                                        left: 4px;
                                        bottom: 4px;
                                        background-color: white;
                                        transition: .4s;
                                        border-radius: 50%;
                                    }
                                </style>

                                <style>
/* Animation pour le compteur de t√©l√©chargements */
@keyframes countUp {
    from {
        transform: scale(0.8);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

td strong {
    animation: countUp 0.3s ease;
}

/* Style pour les badges de statut */
.status-scheduled {
    background: rgba(255, 170, 0, 0.2);
    color: var(--warning);
    border: 1px solid var(--warning);
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: bold;
}

/* Highlight pour versions programm√©es */
tr:has(.status-scheduled) {
    background: rgba(255, 170, 0, 0.05);
}
</style>

                <!-- Versions du jeu -->
                <div class="section" id="versions">
                    <div class="stat-card" style="border: 1px solid var(--cyan); margin-bottom: 20px;">
                        <span class="stat-icon" style="color: var(--cyan);">
                            <i class="fa-solid fa-power-off"></i>
                        </span>
                        <span class="stat-info">
                            <span class="version-down">T√©l√©chargement Public</span>
                            <p style="font-size: 10px;">(Activer/D√©sactiver l'acc√®s)</p>

                            <label class="switch"
                                style="margin-top: 10px; display: inline-block; position: relative; width: 50px; height: 24px;">
                                <input type="checkbox" id="globalDownloadSwitch" onchange="toggleDownloadState(this)">
                                <span class="slider round"
                                    style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"></span>

                            </label>
                            <span id="switchStatusText" style="font-size: 12px; margin-left: 10px;">Chargement...</span>
                        </span>
                    </div>
                    <div id="versions-dashboard"></div>
 <div class="card" style="margin-bottom: 0;">
        <div class="version-header-actions">
            <h2>üéÆ Gestion des Versions</h2>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="openVersionModal()">
                    <i class="fa-solid fa-plus"></i> Cr√©er une v.
                </button>
                <button class="btn btn-success" onclick="publishNextVersion()">
                    <i class="fa-solid fa-rocket"></i> Publier Proch.
                </button>
                <button class="btn btn-warning" onclick="openCountdownModal()">
                    <i class="fa-solid fa-clock"></i> Countdown
                </button>
                <!-- NOUVEAU : Bouton Archives -->
                <button class="btn" style="background: var(--warning);" onclick="showArchives()">
                    <i class="fa-solid fa-archive"></i> Archives
                </button>
            </div>
        </div>

        <div id="versions-container">
            <p class="loading">Chargement des versions</p>
        </div>
    </div>
                </div>
<div class="section" id="site-settings">
    <div class="card">
        <h2>‚öôÔ∏è Param√®tres du site</h2>
        
        <div class="form-group">
            <label>Version du site *</label>
            <input type="text" id="site-version-input" placeholder="2.1 Beta">
            <small style="color: var(--accent); display: block; margin-top: 5px;">
                Format recommand√© : "X.X Beta" ou "X.X"
            </small>
        </div>
        
        <button class="btn btn-success" onclick="saveSiteVersion()">
            üíæ Enregistrer la version
        </button>
        
        <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 3px solid var(--primary);">
            <strong>Version actuelle :</strong>
            <span id="current-site-version" style="color: var(--cyan); font-size: 1.1rem; margin-left: 10px;">
                Chargement...
            </span>
        </div>
    </div>
</div>
<!-- Section Roadmap -->
<div class="section" id="roadmap">
    <div class="card">
        <div class="version-header-actions">
            <h2>üó∫Ô∏è Gestion de la Roadmap</h2>
            <button class="btn btn-primary" onclick="openRoadmapModal()">
                <i class="fas fa-plus"></i> Ajouter un √©l√©ment
            </button>
        </div>
        <div id="roadmap-container">
            <p class="loading">Chargement...</p>
        </div>
    </div>
</div>
                <!-- Autres sections -->
                <div class="section" id="content">
                    <div class="card">
                        <h2>Contenu du site</h2>
                        <p class="loading">En d√©veloppement</p>
                    </div>
                </div>

                <div class="section" id="media">
                    <div class="card">
                        <h2>Biblioth√®que de m√©dias</h2>
                        <p class="loading">En d√©veloppement</p>
                    </div>
                </div>

                <div class="section" id="forms">
                    <div class="card">
                        <h2>R√©ponses aux formulaires</h2>
                        <!--<p class="loading">En d√©veloppement</p>-->
                        <div id="forms-list"><p class="loading">Chargement...</p></div>
                    </div>
                </div>

                <div class="section" id="users">
                    <div class="card">
                        <h2>üë• Gestion des utilisateurs</h2>
                        <div id="users-list">
                            <p class="loading">Chargement</p>
                        </div>
                    </div>
                </div>
                <!-- NOUVELLE SECTION : Gestion des t√©l√©chargements -->
<div class="section" id="downloads-manage">
    <div class="card">
        <h2>üîß Gestion des t√©l√©chargements</h2>
        
        <div class="download-controls">
            <div class="control-item">
                <label class="switch-label">
                    <input type="checkbox" id="toggle-kit" class="download-toggle">
                    <span class="switch-slider"></span>
                    <span class="control-text">Kit Complet</span>
                </label>
            </div>            
            <div class="control-item">
                <label class="switch-label">
                    <input type="checkbox" id="toggle-pdf" class="download-toggle">
                    <span class="switch-slider"></span>
                    <span class="control-text">PDF Charte Graphique</span>
                </label>
            </div>
            <div class="control-item">
                <label class="switch-label">
                    <input type="checkbox" id="toggle-assets" class="download-toggle">
                    <span class="switch-slider"></span>
                    <span class="control-text">Assets Pack</span>
                </label>
            </div>            
        </div>   
        <button class="btn btn-success" onclick="saveDownloadSettings()" style="margin-top: 20px;">
            üíæ Enregistrer les modifications
        </button>
    </div>
</div>
            </div>
        </div>
    </div>
<!-- MODAL ROADMAP -->
<div id="roadmap-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="roadmap-modal-title">Nouvel √©l√©ment Roadmap</h3>
            <span class="close-modal" onclick="closeRoadmapModal()">&times;</span>
        </div>
        <form id="roadmap-form">
            <input type="hidden" id="r-id">

            <div class="form-section">
                <h4 style="color: var(--cyan); margin-bottom: 15px;">üìã Informations de base</h4>
                
                <div class="form-group">
                    <label>Titre *</label>
                    <input type="text" id="r-title" required placeholder="Nouvelle fonctionnalit√©...">
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="r-description" rows="3" placeholder="D√©tails de l'√©l√©ment..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cat√©gorie *</label>
                        <select id="r-category" required>
                            <option value="feature">‚≠ê Feature</option>
                            <option value="bug">üêõ Bug</option>
                            <option value="design">üé® Design</option>
                            <option value="other">üì¶ Autre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Statut *</label>
                        <select id="r-status" required>
                            <option value="planned">üìã Planifi√©</option>
                            <option value="in_progress">‚öôÔ∏è En cours</option>
                            <option value="completed">‚úÖ Termin√©</option>
                            <option value="cancelled">‚ùå Annul√©</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Priorit√©</label>
                        <select id="r-priority">
                            <option value="0">üü¢ Basse</option>
                            <option value="1">üü° Moyenne</option>
                            <option value="2">üî¥ Haute</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Progression (%)</label>
                        <input type="number" id="r-progress" min="0" max="100" value="0">
                    </div>
                </div>

                <div class="form-group">
                    <label>Date estim√©e</label>
                    <input type="date" id="r-estimated-date">
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="closeRoadmapModal()">‚ùå Annuler</button>
                <button type="submit" class="btn btn-success">üíæ Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL VERSION SIMPLIFI√âE -->
<div id="version-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Nouvelle Version</h3>
            <span class="close-modal" onclick="closeVersionModal()">&times;</span>
        </div>
        <form id="version-form">
            <input type="hidden" id="v-id">

            <!-- SECTION 1 : INFOS DE BASE -->
            <div class="form-section">
                <h4 style="color: var(--cyan); margin-bottom: 15px;">üìã Informations</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Num√©ro de version *</label>
                        <input type="text" id="v-number" required placeholder="1.5.0">
                    </div>
                    <div class="form-group">
                        <label>Date de sortie *</label>
                        <input type="datetime-local" id="v-date" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Titre *</label>
                    <input type="text" id="v-title" required placeholder="Grande mise √† jour">
                </div>

                <div class="form-group">
                    <label>Description courte</label>
                    <textarea id="v-description" rows="2" placeholder="R√©sum√© en 1-2 lignes..."></textarea>
                </div>
            </div>

            <!-- SECTION 2 : CHANGELOG -->
            <div class="form-section">
                <h4 style="color: var(--cyan); margin-bottom: 15px;">üìù Notes de mise √† jour</h4>
                
                <div class="form-group">
                    <textarea id="v-notes" rows="6" placeholder="- Ajout de...&#10;- Correction de...&#10;- Am√©lioration de..."></textarea>
                    <small style="color: var(--text-dim);">Une ligne = un point de changelog</small>
                </div>
            </div>

            <!-- SECTION 3 : T√âL√âCHARGEMENT -->
            <div class="form-section">
                <h4 style="color: var(--cyan); margin-bottom: 15px;">üì• Fichiers</h4>
                
                <div class="form-group">
                    <label>Lien de t√©l√©chargement (URL) *</label>
                    <input type="url" id="v-url" required placeholder="https://...">
                </div>

                <div class="form-group">
                    <label>Taille du fichier</label>
                    <input type="text" id="v-size" placeholder="150 MB">
                    <small style="color: var(--text-dim);">Optionnel, pour l'affichage</small>
                </div>
            </div>

            <!-- SECTION 4 : PUBLICATION -->
            <div class="form-section">
                <h4 style="color: var(--cyan); margin-bottom: 15px;">üöÄ Publication</h4>
                
                <div class="checkbox-group" style="background: rgba(0,255,136,0.1); padding: 15px; border-radius: 8px; border: 1px solid var(--success);">
                    <input type="checkbox" id="v-published">
                    <label for="v-published">
                        <strong>Publier cette version imm√©diatement</strong>
                        <br>
                        <small style="color: var(--text-dim);">Si d√©coch√©, reste en brouillon</small>
                    </label>
                </div>
            </div>
            <button type="button" class="btn btn-primary" onclick="scheduleVersion(document.getElementById('v-id').value)">
    ‚è∞ Programmer
</button>

<div class="modal-footer">
    <button type="button" class="btn btn-danger" onclick="closeVersionModal()">‚ùå Annuler</button>
    
    <!-- NOUVEAU : Bouton Programmer -->
    <button type="button" class="btn btn-primary" onclick="scheduleVersion(document.getElementById('v-id').value)" 
            id="btn-schedule" style="display: none;">
        ‚è∞ Programmer
    </button>
    
    <button type="submit" class="btn btn-success">üíæ Enregistrer</button>
</div>
        </form>
    </div>
</div>

    <!-- MODAL COUNTDOWN -->
    <div id="countdown-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚è∞ Configuration du Compte √† Rebours</h3>
                <span class="close-modal" onclick="closeCountdownModal()">&times;</span>
            </div>
            <form id="countdown-form">
                <div class="form-group">
                    <label>Nom de l'√©v√©nement *</label>
                    <input type="text" id="cd-event-name" required placeholder="Lancement de la version b√™ta">
                </div>

                <div class="form-group">
                    <label>Version associ√©e</label>
                    <select id="cd-version">
                        <option value="">S√©lectionner une version</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Date et heure cible *</label>
                    <input type="datetime-local" id="cd-target-date" required>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="cd-description" rows="3"></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="closeCountdownModal()">Annuler</button>
                    <button type="submit" class="btn btn-success">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuration Supabase (utiliser une variable locale pour √©viter la red√©claration)
        const SUPABASE_URL = 'https://apwhdqpdugvhwdvjlbee.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_U4b6xa4sBwEEs1heHmcEGg_M7MA5sB1';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUserProfile = null;

function getSupabase() {
        // On cherche le client partout o√π il pourrait √™tre d√©fini
        return window.EchoSupabase || window.supabaseClient || (window.EchoDB ? window.EchoDB.supabase : null);
    }

    async function waitForSupabase() {
        return new Promise(resolve => {
            const client = getSupabase();
            if (client) return resolve(client);

            const interval = setInterval(() => {
                const clientNow = getSupabase();
                if (clientNow) {
                    clearInterval(interval);
                    resolve(clientNow);
                }
            }, 100);
        });
    }

        // ===== AUTHENTIFICATION =====
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', data.user.id)
                    .single();

                if (profile && (profile.role === 'admin' || profile.role === 'collaborator')) {
                    currentUserProfile = profile;
                    showDashboard(data.user, profile);
                } else {
                    showError('Acc√®s refus√© : vous devez √™tre administrateur ou collaborateur');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion : ' + error.message);
            }

            return false;
        });

        function showError(message) {
            document.getElementById('error-container').innerHTML =
                `<div class="error-message">${message}</div>`;
        }

        function showDashboard(user, profile) {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('user-email').textContent = user.email;

            const roleBadge = document.getElementById('user-role-badge');
            roleBadge.textContent = profile.role === 'admin' ? 'Admin' : 'Collaborateur';
            roleBadge.className = `role-badge role-${profile.role}`;

            loadDashboardData();
        }

        window.logout = async function () {
            await supabaseClient.auth.signOut();
            location.reload();
        };

        // ===== NAVIGATION =====
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;

                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(section).classList.add('active');

                if (section === 'versions') {
                    loadVersions();
                }
                if (section === 'users') {
                    loadUsers();
                }
            });
        });

        // ===== CHARGEMENT DES DONN√âES =====
        async function loadDashboardData() {
            try {
                const [users, media, content, responses] = await Promise.all([
                    supabaseClient.from('profiles').select('id', { count: 'exact', head: true }),
                    supabaseClient.from('media').select('id', { count: 'exact', head: true }),
                    supabaseClient.from('site_content').select('id', { count: 'exact', head: true }),
                    supabaseClient.from('form_responses').select('id', { count: 'exact', head: true })
                ]);

                document.getElementById('stats-users').textContent = users.count || 0;
                document.getElementById('stats-media').textContent = media.count || 0;
                document.getElementById('stats-content').textContent = content.count || 0;
                document.getElementById('stats-responses').textContent = responses.count || 0;

                await loadRecentActivity();
            } catch (error) {
                console.error('Erreur chargement stats:', error);
            }
        }

        async function loadRecentActivity() {
            try {
                const { data, error } = await supabaseClient
                    .from('downloads')
                    .select('*')
                    .order('downloaded_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                const container = document.getElementById('recent-activity');
                if (data && data.length > 0) {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Version</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(item => `
                                    <tr>
                                        <td>üì• T√©l√©chargement</td>
                                        <td>${item.version}</td>
                                        <td>${new Date(item.downloaded_at).toLocaleString('fr-FR')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p style="color: var(--purple);">Aucune activit√© r√©cente</p>';
                }
            } catch (error) {
                console.error('Erreur activit√©s:', error);
            }
        }
function toggleScheduleButton() {
    const isPublished = document.getElementById('v-published').checked;
    const scheduleBtn = document.getElementById('btn-schedule');
    const versionId = document.getElementById('v-id').value;
    
    if (scheduleBtn) {
        scheduleBtn.style.display = !isPublished && versionId ? 'inline-block' : 'none';
    }
}

// Charger l'√©tat des t√©l√©chargements
async function loadDownloadSettings() {
    try {
        const { data, error } = await supabaseClient
            .from('download_packs')
            .select('*')
            .single();

        if (error) throw error;

        document.getElementById('toggle-assets').checked = data.assets_pack_enabled;
        document.getElementById('toggle-pdf').checked = data.pdf_charter_enabled;
        document.getElementById('toggle-kit').checked = data.complete_kit_enabled;
    } catch (error) {
        console.error('Erreur chargement settings:', error);
    }
}

// Sauvegarder les param√®tres
window.saveDownloadSettings = async function() {
    try {
        const settings = {
            assets_pack_enabled: document.getElementById('toggle-assets').checked,
            pdf_charter_enabled: document.getElementById('toggle-pdf').checked,
            complete_kit_enabled: document.getElementById('toggle-kit').checked,
            updated_at: new Date().toISOString()
        };

        const user = await supabaseClient.auth.getUser();
        if (user.data.user) {
            settings.updated_by = user.data.user.id;
        }

        const { error } = await supabaseClient
            .from('download_packs')
            .update(settings)
            .eq('id', '00000000-0000-0000-0000-000000000001');

        if (error) throw error;

        alert('‚úÖ Param√®tres sauvegard√©s avec succ√®s !');
    } catch (error) {
        console.error('Erreur sauvegarde:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
};

// Charger au clic sur la section
document.querySelector('[data-section="downloads-manage"]')?.addEventListener('click', () => {
    loadDownloadSettings();
});


        // ===== MODAL VERSION (CORRIG√â) =====
// Ouvrir le modal
window.openVersionModal = function () {
    document.getElementById('version-form').reset();
    document.getElementById('v-id').value = '';
    document.getElementById('modal-title').textContent = 'Nouvelle Version';
    document.getElementById('v-date').valueAsDate = new Date();
    document.getElementById('v-published').checked = false; // Par d√©faut : brouillon
    document.getElementById('version-modal').style.display = 'flex';
    document.getElementById('v-published')?.addEventListener('change', toggleScheduleButton);
};

window.closeVersionModal = function () {
    document.getElementById('version-modal').style.display = 'none';
};

// √âditer une version existante
window.editVersion = function (version) {
    document.getElementById('v-id').value = version.id;
    document.getElementById('v-number').value = version.version;
    document.getElementById('v-title').value = version.title || '';
    document.getElementById('v-description').value = version.description || '';
    
    if (version.changelog && Array.isArray(version.changelog)) {
        document.getElementById('v-notes').value = version.changelog.join('\n');
    } else {
        document.getElementById('v-notes').value = '';
    }
    
    document.getElementById('v-url').value = version.download_url || '';
    document.getElementById('v-size').value = version.file_size || '';
    document.getElementById('v-date').value = version.release_date ? version.release_date.slice(0, 16) : '';
    document.getElementById('v-published').checked = version.is_published || false;

    document.getElementById('modal-title').textContent = 'Modifier la Version';
    document.getElementById('version-modal').style.display = 'flex';
    document.getElementById('v-published')?.addEventListener('change', toggleScheduleButton);
};

// Soumettre le formulaire
document.getElementById('version-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('v-id').value;
    const notesText = document.getElementById('v-notes').value;
    const changelog = notesText ? notesText.split('\n').filter(line => line.trim()) : null;

    const data = {
        version: document.getElementById('v-number').value,
        title: document.getElementById('v-title').value,
        description: document.getElementById('v-description').value,
        changelog: changelog,
        download_url: document.getElementById('v-url').value || null,
        file_size: document.getElementById('v-size').value || null,
        release_date: document.getElementById('v-date').value,
        is_published: document.getElementById('v-published').checked
    };

    try {
        if (id) {
            const { error } = await supabaseClient
                .from('game_versions')
                .update(data)
                .eq('id', id);
            if (error) throw error;
        } else {
            const { error } = await supabaseClient
                .from('game_versions')
                .insert([data]);
            if (error) throw error;
        }

        closeVersionModal();
        loadVersions();
        alert('‚úÖ Version enregistr√©e !');
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
});

        // ===== MARQUER COMME PROCHAINE VERSION =====
        window.setAsNext = async function (id) {
            if (!confirm('Marquer cette version comme "prochaine" ?')) return;

            try {
                // Retirer le flag des autres
                await supabaseClient
                    .from('game_versions')
                    .update({ is_next: false })
                    .neq('id', id);

                // Activer sur celle-ci
                const { error } = await supabaseClient
                    .from('game_versions')
                    .update({ is_next: true })
                    .eq('id', id);

                if (error) throw error;

                loadVersions();
                alert('‚úÖ Marqu√©e comme prochaine version !');
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur : ' + error.message);
            }
        };

        // ===== PUBLIER PROCHAINE VERSION =====
        window.publishNextVersion = async function () {
            try {
                const { data: nextVersion, error: fetchError } = await supabaseClient
                    .from('game_versions')
                    .select('*')
                    .eq('is_next', true)
                    .single();

                if (fetchError || !nextVersion) {
                    alert('‚ö†Ô∏è Aucune version marqu√©e comme "prochaine"');
                    return;
                }

                if (!confirm(`Publier la version ${nextVersion.version} maintenant ?`)) return;

                // Mettre √† jour la date de release √† maintenant
                const { error } = await supabaseClient
                    .from('game_versions')
                    .update({
                        release_date: new Date().toISOString(),
                        is_next: false
                    })
                    .eq('id', nextVersion.id);

                if (error) throw error;

                loadVersions();
                alert('‚úÖ Version publi√©e !');
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur : ' + error.message);
            }
        };

        // ===== SUPPRIMER VERSION =====
        window.deleteVersion = async function (id) {
            if (!confirm('‚ö†Ô∏è Supprimer d√©finitivement cette version ?')) return;

            try {
                const { error } = await supabaseClient
                    .from('game_versions')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                loadVersions();
                alert('‚úÖ Version supprim√©e !');
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur : ' + error.message);
            }
        };

        // ===== COUNTDOWN (CORRIG√â) =====
        window.openCountdownModal = function () {
            loadVersionsForCountdown();
            document.getElementById('countdown-modal').style.display = 'flex';
        };

        window.closeCountdownModal = function () {
            document.getElementById('countdown-modal').style.display = 'none';
        };

        async function loadVersionsForCountdown() {
            const select = document.getElementById('cd-version');
            const { data: versions } = await supabaseClient
                .from('game_versions')
                .select('id, version, title')
                .order('release_date', { ascending: false });

            select.innerHTML = '<option value="">S√©lectionner une version</option>';
            versions?.forEach(v => {
                select.innerHTML += `<option value="${v.id}">${v.version} - ${v.title}</option>`;
            });
        }

        document.getElementById('countdown-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            try {
                // D√©sactiver les anciens
                await supabaseClient
                    .from('countdown')
                    .update({ is_active: false })
                    .eq('is_active', true);

                const versionId = document.getElementById('cd-version').value;
                let eventName = document.getElementById('cd-event-name').value;

                if (versionId) {
                    const { data: version } = await supabaseClient
                        .from('game_versions')
                        .select('version')
                        .eq('id', versionId)
                        .single();

                    if (version) {
                        eventName = eventName.replace('{version}', version.version);
                    }
                }

                const { error } = await supabaseClient
                    .from('countdown')
                    .insert({
                        event_name: eventName,
                        target_date: document.getElementById('cd-target-date').value,
                        description: document.getElementById('cd-description').value,
                        version_id: versionId || null,
                        is_active: true
                    });

                if (error) throw error;

                closeCountdownModal();
                alert('‚úÖ Compte √† rebours configur√© !');
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur : ' + error.message);
            }

            return false;
        });
        async function loadForms() {
            try {
                const { data, error } = await window.EchoDB.supabase
                    .from('form_responses')
                    .select('*')
                    .order('submitted_at', { ascending: false });
                if (error) throw error;
                let html = '<table><thead><tr><th>Date</th><th>Nom</th><th>Actions</th></tr></thead><tbody>';
                data?.forEach(response => {
                    html += `
                        <tr>
                            <td>${new Date(response.submitted_at).toLocaleDateString('fr-FR')}</td>
                            <td>${response.responses.name || 'Anonyme'}</td>
                            <td>
                                <button class="action-btn edit" onclick="viewResponse('${response.id}')">√∞≈∏‚Äò¬Å√Ø¬∏¬è</button>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                document.getElementById('forms-list').innerHTML = html;
            } catch (error) {
                console.error('Erreur formulaires:', error);
                document.getElementById('forms-list').innerHTML = '<p style="color: #ff0055;">Erreur de chargement</p>';
            }
        }


// AJOUTER ce script dans admin.html (dans la section <script>)

// Charger la version du site
async function loadSiteVersion() {
    try {
        const { data, error } = await supabaseClient
            .from('site_settings')
            .select('setting_value')
            .eq('setting_key', 'site_version')
            .single();
        
        if (error) throw error;
        
        const versionDisplay = document.getElementById('current-site-version');
        const versionInput = document.getElementById('site-version-input');
        
        if (versionDisplay) versionDisplay.textContent = data.setting_value;
        if (versionInput) versionInput.value = data.setting_value;
    } catch (error) {
        console.error('Erreur chargement version:', error);
    }
}

// Sauvegarder la version du site
window.saveSiteVersion = async function() {
    const newVersion = document.getElementById('site-version-input').value.trim();
    
    if (!newVersion) {
        alert('‚ö†Ô∏è Veuillez entrer une version');
        return;
    }
    
    try {
        const user = await supabaseClient.auth.getUser();
        
        const { error } = await supabaseClient
            .from('site_settings')
            .update({
                setting_value: newVersion,
                updated_at: new Date().toISOString(),
                updated_by: user.data.user?.id
            })
            .eq('setting_key', 'site_version');
        
        if (error) throw error;
        
        alert('‚úÖ Version mise √† jour avec succ√®s !');
        loadSiteVersion();
    } catch (error) {
        console.error('Erreur sauvegarde version:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
};

// Charger au clic sur la section
document.querySelector('[data-section="site-settings"]')?.addEventListener('click', () => {
    loadSiteVersion();
});
// ===== SWITCH GLOBAL =====
async function initDownloadSwitch() {
    try {
        const { data } = await supabaseClient
            .from('download_settings')
            .select('*')
            .single();

        if (data) {
            const switchEl = document.getElementById('globalDownloadSwitch');
            const labelEl = document.getElementById('switchStatusText');

            switchEl.checked = data.enabled;
            labelEl.textContent = data.enabled 
                ? "‚úÖ ACTIF (T√©l√©chargement autoris√©)" 
                : "üö´ INACTIF (T√©l√©chargements bloqu√©s)";
            labelEl.style.color = data.enabled ? "var(--success)" : "var(--danger)";
        }
    } catch (err) {
        console.error("Erreur switch:", err);
    }
}

window.toggleDownloadState = async function(checkbox) {
    const newState = checkbox.checked;
    const labelEl = document.getElementById('switchStatusText');
    labelEl.textContent = "‚è≥ Mise √† jour...";

    try {
        const { error } = await supabaseClient
            .from('download_settings')
            .update({ enabled: newState, updated_at: new Date().toISOString() })
            .eq('id', (await supabaseClient.from('download_settings').select('id').single()).data.id);

        if (error) throw error;

        labelEl.textContent = newState 
            ? "‚úÖ ACTIF (T√©l√©chargement autoris√©)" 
            : "üö´ INACTIF (T√©l√©chargements bloqu√©s)";
        labelEl.style.color = newState ? "var(--success)" : "var(--danger)";

        // ‚≠ê AJOUTER CES LIGNES
        if (window.sendDiscordNotification) {
            await window.sendDiscordNotification(
                newState ? 'download_enabled' : 'download_disabled', 
                {}
            );
        }

        alert(newState ? "‚úÖ T√©l√©chargements ACTIV√âS globalement" : "üö´ T√©l√©chargements BLOQU√âS globalement");
    } catch (err) {
        console.error("Erreur:", err);
        checkbox.checked = !newState;
        labelEl.textContent = "‚ùå Erreur";
    }
};

// =============================================
// CODE √Ä AJOUTER DANS ADMIN.HTML <script>
// =============================================

// 1. WIDGET DASHBOARD DE STATUT
async function loadVersionsDashboard() {
    try {
        const { data: current } = await supabaseClient
            .from('game_versions')
            .select('*, download_stats(download_count)')
            .eq('is_published', true)
            .eq('is_archived', false)
            .order('release_date', { ascending: false })
            .limit(1)
            .single();

        const { data: next } = await supabaseClient
            .from('game_versions')
            .select('*')
            .eq('is_published', false)
            .eq('is_archived', false)
            .order('scheduled_publish_at', { ascending: true })
            .limit(1)
            .maybeSingle();

        const { data: drafts } = await supabaseClient
            .from('game_versions')
            .select('id', { count: 'exact', head: true })
            .eq('is_published', false)
            .eq('is_archived', false);

        const dashboardHTML = `
            <div class="stats-grid" style="margin-bottom: 30px;">
                <div class="stat-card" style="border-color: var(--success);">
                    <div class="stat-label">Version Actuelle</div>
                    <div class="stat-value">${current?.version || 'Aucune'}</div>
                    <div class="stat-detail">${current?.download_stats?.[0]?.download_count || 0} t√©l√©chargements</div>
                </div>
                
                <div class="stat-card" style="border-color: var(--cyan);">
                    <div class="stat-label">Prochaine Sortie</div>
                    <div class="stat-value">${next?.version || 'N/A'}</div>
                    <div class="stat-detail">
                        ${next?.scheduled_publish_at 
                            ? new Date(next.scheduled_publish_at).toLocaleDateString('fr-FR')
                            : 'Non programm√©e'}
                    </div>
                </div>
                
                <div class="stat-card" style="border-color: var(--warning);">
                    <div class="stat-label">Brouillons</div>
                    <div class="stat-value">${drafts?.count || 0}</div>
                    <div class="stat-detail">En attente</div>
                </div>
            </div>
        `;

        const container = document.getElementById('versions-dashboard');
        if (container) container.innerHTML = dashboardHTML;
    } catch (error) {
        console.error('Erreur dashboard:', error);
    }
}

// 2. STATS PAR VERSION
async function loadVersionWithStats(versionId) {
    const { data, error } = await supabaseClient
        .from('game_versions')
        .select(`
            *,
            download_stats(download_count)
        `)
        .eq('id', versionId)
        .single();

    if (error) {
        console.error('Erreur stats version:', error);
        return null;
    }
    return data;
}

// 3. MODIFICATION DU TABLEAU DES VERSIONS (remplace loadVersions)
async function loadVersions() {
    const container = document.getElementById('versions-container');
    container.innerHTML = '<p class="loading">Chargement</p>';

    try {
        const { data: versions } = await supabaseClient
            .from('version_stats')
            .select('*')
            .eq('is_archived', false)
            .order('release_date', { ascending: false });

        if (!versions || versions.length === 0) {
            container.innerHTML = '<p>Aucune version.</p>';
            return;
        }

        const now = new Date();

        container.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>Version</th>
                        <th>Titre</th>
                        <th>Date de sortie</th>
                        <th>üìä T√©l√©ch.</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${versions.map(v => {
                        const releaseDate = new Date(v.release_date);
                        const scheduledDate = v.scheduled_publish_at ? new Date(v.scheduled_publish_at) : null;
                        const isPast = releaseDate <= now;
                        
                        let status = '‚ö´ Brouillon';
                        if (v.is_published) {
                            status = isPast ? 'üü¢ Publi√©e' : 'üîµ Planifi√©e';
                        } else if (scheduledDate && scheduledDate > now) {
                            status = `‚è∞ Programm√©e (${scheduledDate.toLocaleDateString('fr-FR')})`;
                        }

                        return `
                            <tr>
                                <td><strong>${v.version}</strong></td>
                                <td>${v.title || '-'}</td>
                                <td>${releaseDate.toLocaleString('fr-FR')}</td>
                                <td style="text-align: center;">
                                    <strong style="color: var(--cyan);">${v.download_count || 0}</strong>
                                </td>
                                <td>${status}</td>
                                <td>
                                    <button class="action-btn btn-edit" onclick='editVersion(${JSON.stringify(v).replace(/'/g, "&#39;")})'>
                                        ‚úèÔ∏è
                                    </button>
                                    ${!v.is_published ? `
                                        <button class="action-btn btn-publish" onclick="publishVersion('${v.id}')">
                                            üöÄ
                                        </button>
                                    ` : `
                                        <button class="action-btn btn-delete" onclick="unpublishVersion('${v.id}')">
                                            üì¶
                                        </button>
                                    `}
                                    <button class="action-btn" style="background: var(--warning);" onclick="archiveVersion('${v.id}')">
                                        üìÅ
                                    </button>
                                    <button class="action-btn btn-delete" onclick="deleteVersion('${v.id}')">
                                        üóëÔ∏è
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    } catch (error) {
        console.error('Erreur:', error);
        container.innerHTML = '<p style="color: var(--danger);">Erreur de chargement</p>';
    }
}

// 4. ARCHIVAGE
window.archiveVersion = async function(id) {
    if (!confirm('Archiver cette version ? Elle sera masqu√©e mais pas supprim√©e.')) return;
    
    try {
        const { error } = await supabaseClient
            .from('game_versions')
            .update({ is_archived: true })
            .eq('id', id);

        if (error) throw error;
        loadVersions();
        loadVersionsDashboard();
        alert('‚úÖ Version archiv√©e !');
    } catch (err) {
        alert('‚ùå Erreur : ' + err.message);
    }
};

// 5. PROGRAMMATION INTELLIGENTE
window.scheduleVersion = function(versionId) {
    const modal = createModal('‚è∞ Programmer la publication', `
        <form id="schedule-form">
            <div class="form-group">
                <label>Publication dans :</label>
                <select id="schedule-type" onchange="updateScheduleFields()">
                    <option value="custom">üìÖ Date personnalis√©e</option>
                    <option value="hours">‚è∞ Dans X heures</option>
                    <option value="days">üìÜ Dans X jours</option>
                </select>
            </div>

            <div id="schedule-custom" class="form-group">
                <label>Date et heure</label>
                <input type="datetime-local" id="schedule-datetime">
            </div>

            <div id="schedule-relative" class="form-group" style="display: none;">
                <label>D√©lai</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="schedule-amount" min="1" value="1" style="flex: 1;">
                    <select id="schedule-unit" style="flex: 1;">
                        <option value="hours">Heures</option>
                        <option value="days">Jours</option>
                    </select>
                </div>
            </div>

            <div style="background: rgba(0,255,136,0.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
                <p style="margin: 0; font-size: 0.9rem;">
                    üìå La version sera automatiquement publi√©e √† la date/heure choisie
                </p>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="this.closest('.custom-modal').remove()">
                    Annuler
                </button>
                <button type="submit" class="btn btn-success">Programmer</button>
            </div>
        </form>
    `);

    const form = document.getElementById('schedule-form');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        let scheduledDate;
        const type = document.getElementById('schedule-type').value;
        
        if (type === 'custom') {
            scheduledDate = document.getElementById('schedule-datetime').value;
        } else {
            const amount = parseInt(document.getElementById('schedule-amount').value);
            const unit = document.getElementById('schedule-unit').value;
            
            const now = new Date();
            if (unit === 'hours') {
                now.setHours(now.getHours() + amount);
            } else {
                now.setDate(now.getDate() + amount);
            }
            scheduledDate = now.toISOString();
        }

        try {
            const { error } = await supabaseClient
                .from('game_versions')
                .update({ 
                    scheduled_publish_at: scheduledDate,
                    is_published: false
                })
                .eq('id', versionId);

            if (error) throw error;
            
            modal.remove();
            loadVersions();
            loadVersionsDashboard();
            alert('‚úÖ Publication programm√©e !');
        } catch (err) {
            alert('‚ùå Erreur : ' + err.message);
        }
    });
};

window.updateScheduleFields = function() {
    const type = document.getElementById('schedule-type').value;
    const customDiv = document.getElementById('schedule-custom');
    const relativeDiv = document.getElementById('schedule-relative');
    const unitSelect = document.getElementById('schedule-unit');
    
    if (type === 'custom') {
        customDiv.style.display = 'block';
        relativeDiv.style.display = 'none';
    } else {
        customDiv.style.display = 'none';
        relativeDiv.style.display = 'block';
        unitSelect.value = type;
    }
};

// 6. INCR√âMENTER T√âL√âCHARGEMENTS (appel depuis buttons.js)
window.trackVersionDownload = async function(versionId) {
    try {
        await supabaseClient.rpc('increment_download_count', { 
            p_version_id: versionId 
        });
    } catch (error) {
        console.error('Erreur tracking:', error);
    }
};

// 8. INITIALISATION AU CHARGEMENT DE LA SECTION VERSIONS
document.querySelector('[data-section="versions"]')?.addEventListener('click', () => {
    loadVersionsDashboard();
    loadVersions();
});

// 9. VOIR LES ARCHIVES
window.showArchives = async function() {
    const { data: archived } = await supabaseClient
        .from('game_versions')
        .select('*')
        .eq('is_archived', true)
        .order('release_date', { ascending: false });

    const modal = createModal('üìÅ Versions archiv√©es', `
        ${archived && archived.length > 0 ? `
            <table>
                <thead>
                    <tr>
                        <th>Version</th>
                        <th>Titre</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${archived.map(v => `
                        <tr>
                            <td>${v.version}</td>
                            <td>${v.title}</td>
                            <td>
                                <button class="action-btn btn-edit" onclick="unarchiveVersion('${v.id}')">
                                    üì§ Restaurer
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        ` : '<p style="text-align: center; color: var(--purple);">Aucune version archiv√©e</p>'}
    `);
};

window.unarchiveVersion = async function(id) {
    try {
        const { error } = await supabaseClient
            .from('game_versions')
            .update({ is_archived: false })
            .eq('id', id);

        if (error) throw error;
        
        const modal = document.querySelector('.custom-modal');
        if (modal) modal.remove();
        
        loadVersions();
        alert('‚úÖ Version restaur√©e !');
    } catch (err) {
        alert('‚ùå Erreur : ' + err.message);
    }
};
// ===== ACTIONS =====
window.publishVersion = async function(id) {
    if (!confirm('Publier cette version ?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('game_versions')
            .update({ is_published: true })
            .eq('id', id);

        if (error) throw error;
        loadVersions();
        alert('‚úÖ Version publi√©e !');
    } catch (err) {
        alert('‚ùå Erreur : ' + err.message);
    }
};

window.unpublishVersion = async function(id) {
    if (!confirm('D√©publier cette version ?')) return;
    
    try {
        const { error } = await supabaseClient
            .from('game_versions')
            .update({ is_published: false })
            .eq('id', id);

        if (error) throw error;
        loadVersions();
        alert('‚úÖ Version d√©publi√©e !');
    } catch (err) {
        alert('‚ùå Erreur : ' + err.message);
    }
};
        // Lancer au chargement de la page
        document.addEventListener('DOMContentLoaded', initDownloadSwitch);


        // ===== INITIALISATION =====
        (async () => {
            const { data: { user } } = await supabaseClient.auth.getUser();

            if (user) {
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (profile && (profile.role === 'admin' || profile.role === 'collaborator')) {
                    currentUserProfile = profile;
                    showDashboard(user, profile);
                }
            }
        })();


        // ===== GESTION DES UTILISATEURS =====
        async function loadUsers() {
            if (currentUserProfile.role !== 'admin') {
                document.getElementById('users-list').innerHTML = '<p style="color: var(--danger);">Acc√®s refus√© - Admin uniquement</p>';
                return;
            }

            const container = document.getElementById('users-list');
            container.innerHTML = '<p class="loading">Chargement</p>';

            try {
                const { data: users, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!users || users.length === 0) {
                    container.innerHTML = '<p style="color: var(--purple);">Aucun utilisateur</p>';
                    return;
                }

                let html = `
            <table>
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email (ID)</th>
                        <th>R√¥le</th>
                        <th>Date inscription</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;

                users.forEach(user => {
                    html += `
                <tr>
                    <td>${user.username || 'N/A'}</td>
                    <td>${user.id}</td>
                    <td><span class="role-badge role-${user.role}">${user.role}</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString('fr-FR')}</td>
                    <td>
                        <select onchange="changeUserRole('${user.id}', this.value)" 
                                style="background: rgba(0,0,0,0.4); color: white; border: 1px solid var(--purple); padding: 8px; border-radius: 6px; cursor: pointer;">
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>Utilisateur</option>
                            <option value="collaborator" ${user.role === 'collaborator' ? 'selected' : ''}>Collaborateur</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </td>
                </tr>
            `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Erreur chargement utilisateurs:', error);
                container.innerHTML = '<p style="color: var(--danger);">Erreur : ' + error.message + '</p>';
            }
        }

        window.changeUserRole = async function (userId, newRole) {
            if (currentUserProfile.role !== 'admin') {
                alert('‚ùå Seuls les admins peuvent modifier les r√¥les');
                return;
            }

            if (!confirm(`Changer le r√¥le de cet utilisateur en "${newRole}" ?`)) {
                loadUsers(); // Recharger pour reset le select
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ role: newRole })
                    .eq('id', userId);

                if (error) throw error;

                alert('‚úÖ R√¥le mis √† jour avec succ√®s !');
                loadUsers();
            } catch (error) {
                console.error('Erreur changement r√¥le:', error);
                alert('‚ùå Erreur : ' + error.message);
                loadUsers();
            }
        };


// =============================================
// GESTION DE LA ROADMAP
// =============================================

// Charger la roadmap
async function loadRoadmap() {
    const container = document.getElementById('roadmap-container');
    container.innerHTML = '<p class="loading">Chargement...</p>';

    try {
        const { data: items, error } = await supabaseClient
            .from('roadmap_items')
            .select('*')
            .order('order_index', { ascending: true });

        if (error) throw error;

        if (!items || items.length === 0) {
            container.innerHTML = '<p style="color: var(--purple);">Aucun √©l√©ment dans la roadmap</p>';
            return;
        }

        const grouped = {
            planned: items.filter(i => i.status === 'planned'),
            in_progress: items.filter(i => i.status === 'in_progress'),
            completed: items.filter(i => i.status === 'completed'),
            cancelled: items.filter(i => i.status === 'cancelled')
        };

        const statusLabels = {
            planned: 'üìã Planifi√©',
            in_progress: '‚öôÔ∏è En cours',
            completed: '‚úÖ Termin√©',
            cancelled: '‚ùå Annul√©'
        };

        const categoryColors = {
            feature: 'var(--success)',
            bug: 'var(--danger)',
            design: 'var(--warning)',
            other: 'var(--purple)'
        };

        const priorityLabels = {
            0: 'üü¢ Basse',
            1: 'üü° Moyenne',
            2: 'üî¥ Haute'
        };

        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';

        Object.entries(grouped).forEach(([status, statusItems]) => {
            if (status === 'cancelled' && statusItems.length === 0) return;

            html += `
                <div class="card" style="background: rgba(0, 0, 0, 0.2); padding: 20px;">
                    <h3 style="color: var(--cyan); margin-bottom: 15px;">
                        ${statusLabels[status]}
                        <span class="role-badge" style="background: rgba(0, 208, 198, 0.2); color: var(--cyan);">
                            ${statusItems.length}
                        </span>
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
            `;

            statusItems.forEach(item => {
                html += `
                    <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-left: 4px solid ${categoryColors[item.category]}; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='var(--cyan)'" onmouseout="this.style.borderColor='rgba(255, 255, 255, 0.1)'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: var(--text); margin-bottom: 5px;">${item.title}</div>
                                ${item.description ? `<div style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 8px;">${item.description}</div>` : ''}
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                                    <span style="padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; background: rgba(${item.category === 'feature' ? '0, 255, 136' : item.category === 'bug' ? '255, 0, 85' : item.category === 'design' ? '255, 170, 0' : '135, 53, 185'}, 0.2); color: ${categoryColors[item.category]}; border: 1px solid ${categoryColors[item.category]};">${item.category}</span>
                                    <span style="padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; background: rgba(255, 255, 255, 0.05); color: var(--text-dim);">${priorityLabels[item.priority]}</span>
                                    ${item.estimated_date ? `<span style="padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; background: rgba(255, 255, 255, 0.05); color: var(--text-dim);">üìÖ ${new Date(item.estimated_date).toLocaleDateString('fr-FR')}</span>` : ''}
                                </div>
                                <div style="margin-bottom: 5px;">
                                    <div style="background: rgba(255, 255, 255, 0.1); height: 6px; border-radius: 3px; overflow: hidden;">
                                        <div style="background: linear-gradient(90deg, var(--cyan), var(--purple)); height: 100%; width: ${item.progress}%; transition: width 0.3s;"></div>
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 3px;">${item.progress}% compl√©t√©</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px; color: var(--cyan); font-size: 0.9rem;"><i class="fas fa-thumbs-up"></i> <span>${item.votes || 0} votes</span></div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                            <button class="action-btn btn-edit" onclick='editRoadmapItem(${JSON.stringify(item).replace(/'/g, "&#39;")})'>‚úèÔ∏è Modifier</button>
                            <button class="action-btn btn-delete" onclick="deleteRoadmapItem('${item.id}')">üóëÔ∏è Supprimer</button>
                        </div>
                    </div>
                `;
            });

            html += '</div></div>';
        });

        html += '</div>';
        container.innerHTML = html;

    } catch (error) {
        console.error('Erreur chargement roadmap:', error);
        container.innerHTML = '<p style="color: var(--danger);">Erreur de chargement</p>';
    }
}

window.openRoadmapModal = function() {
    document.getElementById('roadmap-form').reset();
    document.getElementById('r-id').value = '';
    document.getElementById('roadmap-modal-title').textContent = 'Nouvel √©l√©ment Roadmap';
    document.getElementById('r-progress').value = 0;
    document.getElementById('roadmap-modal').style.display = 'flex';
};

window.closeRoadmapModal = function() {
    document.getElementById('roadmap-modal').style.display = 'none';
};

window.editRoadmapItem = function(item) {
    document.getElementById('r-id').value = item.id;
    document.getElementById('r-title').value = item.title;
    document.getElementById('r-description').value = item.description || '';
    document.getElementById('r-category').value = item.category;
    document.getElementById('r-status').value = item.status;
    document.getElementById('r-priority').value = item.priority;
    document.getElementById('r-progress').value = item.progress;
    if (item.estimated_date) {
        document.getElementById('r-estimated-date').value = item.estimated_date;
    }
    document.getElementById('roadmap-modal-title').textContent = 'Modifier l\'√©l√©ment';
    document.getElementById('roadmap-modal').style.display = 'flex';
};

document.getElementById('roadmap-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('r-id').value;
    const data = {
        title: document.getElementById('r-title').value,
        description: document.getElementById('r-description').value || null,
        category: document.getElementById('r-category').value,
        status: document.getElementById('r-status').value,
        priority: parseInt(document.getElementById('r-priority').value),
        progress: parseInt(document.getElementById('r-progress').value),
        estimated_date: document.getElementById('r-estimated-date').value || null,
        updated_at: new Date().toISOString()
    };

    try {
        if (id) {
            const { error } = await supabaseClient.from('roadmap_items').update(data).eq('id', id);
            if (error) throw error;
        } else {
            const user = await supabaseClient.auth.getUser();
            data.created_by = user.data.user?.id;
            const { error } = await supabaseClient.from('roadmap_items').insert([data]);
            if (error) throw error;
        }
        closeRoadmapModal();
        loadRoadmap();
        alert('‚úÖ √âl√©ment enregistr√© !');
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
});

window.deleteRoadmapItem = async function(id) {
    if (!confirm('‚ö†Ô∏è Supprimer d√©finitivement cet √©l√©ment de la roadmap ?')) return;
    try {
        const { error } = await supabaseClient.from('roadmap_items').delete().eq('id', id);
        if (error) throw error;
        loadRoadmap();
        alert('‚úÖ √âl√©ment supprim√© !');
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur : ' + error.message);
    }
};

document.querySelector('[data-section="roadmap"]')?.addEventListener('click', () => {
    loadRoadmap();
});

        // =============================================
        // ANALYTICS AVANC√âES POUR LES NOTIFICATIONS
        // √Ä ajouter dans admin.html
        // =============================================

        class NotificationAnalytics {
            constructor() {
                this.stats = {};
                this.charts = {};
            }

            async loadAdvancedStats() {
                try {
                    // Statistiques g√©n√©rales
                    const generalStats = await this.getGeneralStats();

                    // Taux de lecture par type
                    const readRateByType = await this.getReadRateByType();

                    // Notifications par jour (7 derniers jours)
                    const dailyStats = await this.getDailyStats();

                    // Top utilisateurs (plus actifs)
                    //const topUsers = await this.getTopUsers();

                    // Afficher les r√©sultats
                    this.displayGeneralStats(generalStats);
                    this.displayReadRateChart(readRateByType);
                    this.displayDailyChart(dailyStats);
                    //this.displayTopUsers(topUsers);

                } catch (error) {
                    console.error('Erreur chargement analytics:', error);
                }
            }

            async getGeneralStats() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                const [total, todayCount, yesterdayCount, readCount, avgReadTime] = await Promise.all([
                    // Total
                    supabaseClient.from('notifications')
                        .select('id', { count: 'exact', head: true }),

                    // Aujourd'hui
                    supabaseClient.from('notifications')
                        .select('id', { count: 'exact', head: true })
                        .gte('created_at', today.toISOString()),

                    // Hier
                    supabaseClient.from('notifications')
                        .select('id', { count: 'exact', head: true })
                        .gte('created_at', yesterday.toISOString())
                        .lt('created_at', today.toISOString()),

                    // Lues
                    supabaseClient.from('notifications')
                        .select('id', { count: 'exact', head: true })
                        .eq('is_read', true),

                    // Temps moyen de lecture
                    supabaseClient.from('notifications')
                        .select('created_at')
                        //.not('read_at', 'is', null)
                ]);

                // Calculer le temps moyen de lecture
                let avgMinutes = 0;
                if (avgReadTime.data && avgReadTime.data.length > 0) {
                    const totalMinutes = avgReadTime.data.reduce((sum, notif) => {
                        const created = new Date(notif.created_at);
                        const read = new Date(notif.read_at);
                        return sum + (read - created) / 60000; // En minutes
                    }, 0);
                    avgMinutes = Math.round(totalMinutes / avgReadTime.data.length);
                }

                return {
                    total: total.count || 0,
                    today: todayCount.count || 0,
                    yesterday: yesterdayCount.count || 0,
                    read: readCount.count || 0,
                    readRate: total.count > 0 ? Math.round((readCount.count / total.count) * 100) : 0,
                    avgReadTime: avgMinutes,
                    growth: yesterdayCount.count > 0
                        ? Math.round(((todayCount.count - yesterdayCount.count) / yesterdayCount.count) * 100)
                        : 0
                };
            }

            async getReadRateByType() {
                const { data } = await supabaseClient
                    .from('notifications')
                    .select('is_read');

                if (!data) return [];

                const stats = data.reduce((acc, notif) => {
                    if (!acc[notif.type]) {
                        acc[notif.type] = { total: 0, read: 0 };
                    }
                    acc[notif.type].total++;
                    if (notif.is_read) acc[notif.type].read++;
                    return acc;
                }, {});

                return Object.entries(stats).map(([type, counts]) => ({
                    type,
                    readRate: Math.round((counts.read / counts.total) * 100),
                    total: counts.total,
                    read: counts.read
                }));
            }

            async getDailyStats() {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

                const { data } = await supabaseClient
                    .from('notifications')
                    .select('created_at, is_read')
                    .gte('created_at', sevenDaysAgo.toISOString())
                    .order('created_at', { ascending: true });

                if (!data) return [];

                // Grouper par jour
                const dailyStats = {};
                data.forEach(notif => {
                    const date = new Date(notif.created_at).toLocaleDateString('fr-FR');
                    if (!dailyStats[date]) {
                        dailyStats[date] = { sent: 0, read: 0 };
                    }
                    dailyStats[date].sent++;
                    if (notif.is_read) dailyStats[date].read++;
                });

                return Object.entries(dailyStats).map(([date, stats]) => ({
                    date,
                    ...stats
                }));
            }

            /*async getTopUsers() {
                const { data } = await supabaseClient
                    .from('notifications')
                    .select(`
                recipient_id,
                is_read,
                profiles:recipient_id (username, email)
            `)
                    .not('recipient_id', 'is', null);

                if (!data) return [];

                // Grouper par utilisateur
                const userStats = data.reduce((acc, notif) => {
                    const userId = notif.recipient_id;
                    if (!acc[userId]) {
                        acc[userId] = {
                            userId,
                            username: notif.profiles?.username || notif.profiles?.email || 'Anonyme',
                            total: 0,
                            read: 0
                        };
                    }
                    acc[userId].total++;
                    if (notif.is_read) acc[userId].read++;
                    return acc;
                }, {});

                // Convertir en tableau et trier
                return Object.values(userStats)
                    .sort((a, b) => b.total - a.total)
                    .slice(0, 10); // Top 10
            }*/

            displayGeneralStats(stats) {
                const container = document.getElementById('analytics-general');
                if (!container) return;

                const growthIcon = stats.growth > 0 ? 'üìà' : stats.growth < 0 ? 'üìâ' : '‚û°Ô∏è';
                const growthColor = stats.growth > 0 ? 'var(--success)' : stats.growth < 0 ? 'var(--danger)' : 'var(--text-dim)';

                container.innerHTML = `
            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                <div class="stat-card">
                    <div class="stat-label">Taux de lecture</div>
                    <div class="stat-value">${stats.readRate}%</div>
                    <div class="stat-detail">${stats.read} / ${stats.total}</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Aujourd'hui</div>
                    <div class="stat-value">${stats.today}</div>
                    <div class="stat-detail" style="color: ${growthColor};">
                        ${growthIcon} ${Math.abs(stats.growth)}% vs hier
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Temps moyen de lecture</div>
                    <div class="stat-value">${stats.avgReadTime}min</div>
                    <div class="stat-detail">Cr√©ation ‚Üí Lecture</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Total envoy√©es</div>
                    <div class="stat-value">${stats.total}</div>
                    <div class="stat-detail">Depuis le d√©but</div>
                </div>
            </div>
        `;
            }

            displayReadRateChart(data) {
                const container = document.getElementById('analytics-read-rate');
                if (!container) return;

                const colors = {
                    info: 'var(--cyan)',
                    success: 'var(--success)',
                    warning: 'var(--warning)',
                    danger: 'var(--danger)'
                };

                const maxValue = Math.max(...data.map(d => d.total));

                container.innerHTML = `
            <h3>üìä Taux de lecture par type</h3>
            <div class="chart-container" style="padding: 20px;">
                ${data.map(item => `
                    <div class="chart-bar" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="text-transform: capitalize; font-weight: bold; color: ${colors[item.type]};">
                                ${item.type}
                            </span>
                            <span style="color: var(--text-dim);">
                                ${item.read}/${item.total} (${item.readRate}%)
                            </span>
                        </div>
                        <div style="
                            background: rgba(0, 0, 0, 0.3);
                            height: 30px;
                            border-radius: 15px;
                            overflow: hidden;
                            position: relative;
                        ">
                            <div style="
                                background: ${colors[item.type]};
                                height: 100%;
                                width: ${item.readRate}%;
                                transition: width 1s ease;
                                display: flex;
                                align-items: center;
                                justify-content: flex-end;
                                padding-right: 10px;
                                font-size: 12px;
                                font-weight: bold;
                            ">
                                ${item.readRate}%
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
            }

            displayDailyChart(data) {
                const container = document.getElementById('analytics-daily');
                if (!container) return;

                const maxValue = Math.max(...data.map(d => Math.max(d.sent, d.read)));

                container.innerHTML = `
            <h3>üìÖ Activit√© des 7 derniers jours</h3>
            <div class="chart-container" style="padding: 20px;">
                <div style="display: flex; align-items: flex-end; justify-content: space-between; height: 200px; gap: 5px;">
                    ${data.map(day => `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 2px; width: 100%;">
                                <div style="
                                    background: var(--cyan);
                                    width: 100%;
                                    height: ${(day.sent / maxValue) * 150}px;
                                    border-radius: 8px 8px 0 0;
                                    transition: all 0.3s;
                                    position: relative;
                                    cursor: pointer;
                                " title="Envoy√©es: ${day.sent}">
                                    <span style="
                                        position: absolute;
                                        top: -20px;
                                        left: 50%;
                                        transform: translateX(-50%);
                                        font-size: 11px;
                                        font-weight: bold;
                                        color: var(--cyan);
                                    ">${day.sent}</span>
                                </div>
                                <div style="
                                    background: var(--success);
                                    width: 100%;
                                    height: ${(day.read / maxValue) * 150}px;
                                    border-radius: 0 0 8px 8px;
                                    transition: all 0.3s;
                                    position: relative;
                                    cursor: pointer;
                                " title="Lues: ${day.read}">
                                    <span style="
                                        position: absolute;
                                        bottom: -20px;
                                        left: 50%;
                                        transform: translateX(-50%);
                                        font-size: 11px;
                                        font-weight: bold;
                                        color: var(--success);
                                    ">${day.read}</span>
                                </div>
                            </div>
                            <span style="font-size: 10px; color: var(--text-dim); margin-top: 30px;">
                                ${day.date.split('/').slice(0, 2).join('/')}
                            </span>
                        </div>
                    `).join('')}
                </div>
                <div style="display: flex; justify-content: center; gap: 20px; margin-top: 30px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: var(--cyan); border-radius: 4px;"></div>
                        <span style="font-size: 13px;">Envoy√©es</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; background: var(--success); border-radius: 4px;"></div>
                        <span style="font-size: 13px;">Lues</span>
                    </div>
                </div>
            </div>
        `;
            }

            displayTopUsers(users) {
                const container = document.getElementById('analytics-top-users');
                if (!container) return;

                container.innerHTML = `
            <h3>üèÜ Top 10 utilisateurs</h3>
            <div style="padding: 15px;">
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Utilisateur</th>
                            <th>Re√ßues</th>
                            <th>Lues</th>
                            <th>Taux</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map((user, index) => {
                    const rate = Math.round((user.read / user.total) * 100);
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';

                    return `
                                <tr>
                                    <td>${medal || (index + 1)}</td>
                                    <td style="font-weight: bold;">${user.username}</td>
                                    <td>${user.total}</td>
                                    <td>${user.read}</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="
                                                background: rgba(0, 0, 0, 0.3);
                                                height: 8px;
                                                border-radius: 4px;
                                                flex: 1;
                                                overflow: hidden;
                                            ">
                                                <div style="
                                                    background: var(--success);
                                                    height: 100%;
                                                    width: ${rate}%;
                                                    transition: width 0.5s ease;
                                                "></div>
                                            </div>
                                            <span style="font-size: 12px; min-width: 40px;">${rate}%</span>
                                        </div>
                                    </td>
                                </tr>
                            `;
                }).join('')}
                    </tbody>
                </table>
            </div>
        `;
            }
        }

        // =============================================
        // HTML √Ä AJOUTER DANS ADMIN.HTML
        // =============================================

        const ANALYTICS_HTML = `
<div class="card">
    <h2>üìä Analytics avanc√©es</h2>
    
    <div id="analytics-general"></div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 30px;">
        <div class="card" style="background: rgba(0, 0, 0, 0.2);" id="analytics-read-rate"></div>
        <div class="card" style="background: rgba(0, 0, 0, 0.2);" id="analytics-daily"></div>
    </div>
    
    <div class="card" style="background: rgba(0, 0, 0, 0.2); margin-top: 20px;" id="analytics-top-users"></div>
    
    <div style="display: flex; justify-content: center; margin-top: 20px;">
        <button class="btn btn-primary" onclick="refreshAnalytics()">
            <i class="fa-solid fa-sync"></i> Actualiser
        </button>
    </div>
</div>
`;

        // Initialiser les analytics
        let analyticsInstance;

        document.querySelector('[data-section="notifications"]')?.addEventListener('click', async () => {
            // Attendre un peu que la section soit affich√©e
            setTimeout(async () => {
                if (!analyticsInstance) {
                    analyticsInstance = new NotificationAnalytics();
                }

                // Injecter le HTML si pas d√©j√† fait
                if (!document.getElementById('analytics-general')) {
                    const notificationsSection = document.getElementById('notifications');
                    if (notificationsSection) {
                        notificationsSection.insertAdjacentHTML('beforeend', ANALYTICS_HTML);
                    }
                }

                await analyticsInstance.loadAdvancedStats();
            }, 100);
        });

        // Fonction de refresh
        window.refreshAnalytics = async function () {
            if (analyticsInstance) {
                await analyticsInstance.loadAdvancedStats();
            }
        };

        // Auto-refresh toutes les 30 secondes si la section est visible
        setInterval(() => {
            const section = document.getElementById('notifications');
            if (section && section.classList.contains('active') && analyticsInstance) {
                analyticsInstance.loadAdvancedStats();
            }
        }, 30000);
    </script>
    <script src="js/notifications.js"></script>

    <script>
        // =============================================
        // GESTION DES NOTIFICATIONS ADMIN
        // =============================================

        // Charger les utilisateurs pour le s√©lecteur
        async function loadUsersForNotifications() {
            const select = document.getElementById('notif-recipient-user');

            try {
                const { data: users } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .order('username');

                select.innerHTML = '<option value="">S√©lectionner un utilisateur</option>';

                users?.forEach(user => {
                    select.innerHTML += `<option value="${user.id}">${user.username || user.email}</option>`;
                });
            } catch (error) {
                console.error('Erreur chargement utilisateurs:', error);
            }
        }

        // G√©rer l'affichage des champs conditionnels
        document.getElementById('notif-recipient-type')?.addEventListener('change', (e) => {
            const recipientGroup = document.getElementById('recipient-select-group');
            const roleGroup = document.getElementById('role-select-group');

            recipientGroup.style.display = e.target.value === 'specific' ? 'block' : 'none';
            roleGroup.style.display = e.target.value === 'role' ? 'block' : 'none';
        });

        document.getElementById('notif-link')?.addEventListener('change', (e) => {
            document.getElementById('link-group').style.display = e.target.checked ? 'block' : 'none';
        });

        // Envoyer une notification
        document.getElementById('notification-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const type = document.getElementById('notif-type').value;
            const title = document.getElementById('notif-title').value;
            const message = document.getElementById('notif-message').value;
            const recipientType = document.getElementById('notif-recipient-type').value;
            const isPersistent = document.getElementById('notif-persistent').checked;
            const hasLink = document.getElementById('notif-link').checked;
            const actionUrl = hasLink ? document.getElementById('notif-action-url').value : null;

            try {
                const user = await supabaseClient.auth.getUser();

                // D√©terminer les destinataires
                let recipients = [];

                if (recipientType === 'all') {
                    // Notification globale
                    const { data } = await supabaseClient
                        .from('profiles')
                        .select('id');
                    recipients = data?.map(u => u.id) || [];
                } else if (recipientType === 'specific') {
                    recipients = [document.getElementById('notif-recipient-user').value];
                } else if (recipientType === 'role') {
                    const role = document.getElementById('notif-recipient-role').value;
                    const { data } = await supabaseClient
                        .from('profiles')
                        .select('id')
                        .eq('role', role);
                    recipients = data?.map(u => u.id) || [];
                }

                const notifications = recipients.map(recipientId => ({
                    title,
                    message,
                }));

                const { error } = await supabaseClient
                    .from('notifications')
                    .insert(notifications);

                if (error) throw error;

                alert(`‚úÖ ${notifications.length} notification(s) envoy√©e(s) avec succ√®s !`);
                document.getElementById('notification-form').reset();
                loadNotificationHistory();
                loadNotificationStats();
            } catch (error) {
                console.error('Erreur envoi notification:', error);
                alert('‚ùå Erreur lors de l\'envoi : ' + error.message);
            }
        });

        // Aper√ßu de la notification
        window.testNotificationPreview = function () {
            const type = document.getElementById('notif-type').value;
            const title = document.getElementById('notif-title').value;
            const message = document.getElementById('notif-message').value;

            if (!title || !message) {
                alert('Veuillez remplir le titre et le message');
                return;
            }

            // Cr√©er un toast de pr√©visualisation
            const preview = {
                type,
                title: title + ' (APER√áU)',
                message
            };

            if (window.notificationSystem) {
                window.notificationSystem.showToast(preview);
            }
        };

async function loadNotificationHistory() {
        const historyContainer = document.getElementById('notification-history-body');
        if (!historyContainer) return;

        try {
            const supabase = await waitForSupabase(); // On attend d'√™tre s√ªr d'avoir le client

            // Requ√™te simplifi√©e : pas de .select(profiles...)
            const { data, error } = await supabase
                .from('notifications')
                .select('id, title, message, created_at, is_read')
                .order('created_at', { ascending: false })
                .limit(20);

            if (error) throw error;

            if (data.length === 0) {
                historyContainer.innerHTML = '<tr><td colspan="4" style="text-align:center;">Aucune notification</td></tr>';
                return;
            }

            historyContainer.innerHTML = data.map(notif => `
                <tr>
                    <td>${new Date(notif.created_at).toLocaleString('fr-FR')}</td>
                    <td>${notif.title}</td>
                    <td>${notif.message}</td>
                    <td>
                        <span class="status-badge ${notif.is_read ? 'status-active' : 'status-inactive'}">
                            ${notif.is_read ? 'Lue' : 'Non lue'}
                        </span>
                    </td>
                </tr>
            `).join('');

        } catch (error) {
            console.error('Erreur chargement historique:', error);
            // CORRECTION: On utilise historyContainer, pas "container"
            if (historyContainer) {
                historyContainer.innerHTML = `<tr><td colspan="4" style="color:red;">Erreur: ${error.message}</td></tr>`;
            }
        }
    }

    // Fonction d'envoi simplifi√©e (Global, pas de destinataire)
    async function sendNotification(event) {
        event.preventDefault();
        
        const title = document.getElementById('notif-title').value;
        const message = document.getElementById('notif-message').value;
        const btn = event.target.querySelector('button');

        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi...';

            const supabase = await waitForSupabase();

            const { error } = await supabase
                .from('notifications')
                .insert([{
                    title: title,
                    message: message,
                    is_read: false
                    // Pas de recipient_id
                }]);

            if (error) throw error;

            alert('Notification envoy√©e avec succ√®s !');
            document.getElementById('notification-form').reset();
            loadNotificationHistory(); // Recharger la liste

        } catch (error) {
            console.error('Erreur envoi:', error);
            alert('Erreur: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Envoyer la notification';
        }
    }

        // Supprimer une notification
        window.deleteNotificationAdmin = async function (id) {
            if (!confirm('Supprimer cette notification ?')) return;

            try {
                const { error } = await supabaseClient
                    .from('notifications')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                loadNotificationHistory();
                loadNotificationStats();
                alert('‚úÖ Notification supprim√©e');
            } catch (error) {
                console.error('Erreur suppression:', error);
                alert('‚ùå Erreur : ' + error.message);
            }
        };

        // Charger les statistiques
        async function loadNotificationStats() {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const [total, todayCount, readCount, unreadCount] = await Promise.all([
                    supabaseClient.from('notifications').select('id', { count: 'exact', head: true }),
                    supabaseClient.from('notifications').select('id', { count: 'exact', head: true })
                        .gte('created_at', today.toISOString()),
                    supabaseClient.from('notifications').select('id', { count: 'exact', head: true })
                        .eq('is_read', true),
                    supabaseClient.from('notifications').select('id', { count: 'exact', head: true })
                        .eq('is_read', false)
                ]);

                document.getElementById('stats-today').textContent = todayCount.count || 0;
                document.getElementById('stats-total').textContent = total.count || 0;
                document.getElementById('stats-unread').textContent = unreadCount.count || 0;

                const readRate = total.count > 0
                    ? Math.round((readCount.count / total.count) * 100)
                    : 0;
                document.getElementById('stats-read-rate').textContent = readRate + '%';
            } catch (error) {
                console.error('Erreur stats:', error);
            }
        }

        // Initialiser lors du chargement de la section
        document.querySelector('[data-section="notifications"]')?.addEventListener('click', () => {
            loadUsersForNotifications();
            loadNotificationHistory();
            loadNotificationStats();
        });


        // Initialiser les notifications
        document.addEventListener('DOMContentLoaded', async () => {
            await new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    if (window.EchoDB && window.supabaseClient) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });

            window.notificationSystem = new NotificationSystem();
        });

// ==========================================
    // 3. INITIALISATION
    // ==========================================
    document.addEventListener('DOMContentLoaded', async () => {
        console.log("‚è≥ Admin : Attente de Supabase...");
        //await waitForSupabase();
        console.log("‚úÖ Admin : Supabase pr√™t !");

        // Initialiser l'historique
        loadNotificationHistory();

        // G√©rer le clic sur l'onglet Notifications
        const notifTab = document.querySelector('[data-section="notifications"]');
        if (notifTab) {
            notifTab.addEventListener('click', () => {
                loadNotificationHistory();
            });
        }

        // Attacher le formulaire
        const form = document.getElementById('notification-form');
        if (form) {
            form.addEventListener('submit', sendNotification);
        }
    });
    </script>
</body>

</html>