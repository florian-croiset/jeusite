<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Tracking Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-danger:hover {
            background: #ee5a6f;
        }

        .btn-success {
            background: #26de81;
            color: white;
        }

        .btn-sm {
            padding: 5px 12px;
            font-size: 14px;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #26de81;
            color: white;
        }

        .badge-warning {
            background: #fed330;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .actions {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Tracking Management Panel</h1>
            <p>G√©rez les webhooks Discord et les utilisateurs track√©s</p>
        </div>

        <!-- Statistics -->
        <div class="section">
            <h2>üìà Statistiques Globales</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Utilisateurs Track√©s</h3>
                    <div class="value" id="stat-users">-</div>
                </div>
                <div class="stat-card">
                    <h3>Sessions Totales</h3>
                    <div class="value" id="stat-sessions">-</div>
                </div>
                <div class="stat-card">
                    <h3>√âv√©nements Totaux</h3>
                    <div class="value" id="stat-events">-</div>
                </div>
                <div class="stat-card">
                    <h3>Webhooks Actifs</h3>
                    <div class="value" id="stat-webhooks">-</div>
                </div>
            </div>
        </div>

        <!-- Webhook Configuration -->
        <div class="section">
            <h2>üîó Configuration Webhook Principal</h2>
            <div id="webhook-config">
                <div class="loading">Chargement...</div>
            </div>
        </div>

        <!-- Tracked Users -->
        <div class="section">
            <h2>üë• Utilisateurs Track√©s</h2>
            <button class="btn btn-primary" onclick="openAddUserModal()">
                + Ajouter un utilisateur
            </button>
            <div id="tracked-users">
                <div class="loading">Chargement...</div>
            </div>
        </div>

        <!-- Recent Sessions -->
        <div class="section">
            <h2>üïê Sessions R√©centes</h2>
            <div id="recent-sessions">
                <div class="loading">Chargement...</div>
            </div>
        </div>
    </div>

    <!-- Modal: Add User -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ajouter un utilisateur track√©</h2>
                <button class="close-btn" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <form id="addUserForm">
                <div class="form-group">
                    <label>Adresse IP *</label>
                    <input type="text" id="user-ip" placeholder="123.45.67.89" required>
                    <small style="color:#999;">Pour obtenir l'IP d'un visiteur, consultez les logs Discord</small>
                </div>
                <div class="form-group">
                    <label>Pr√©nom *</label>
                    <input type="text" id="user-name" placeholder="Florian" required>
                </div>
                <div class="form-group">
                    <label>Webhook Discord Personnel *</label>
                    <input type="url" id="user-webhook" placeholder="https://discord.com/api/webhooks/..." required>
                </div>
                <div class="form-group">
                    <label>Notes (optionnel)</label>
                    <textarea id="user-notes" rows="3" placeholder="D√©veloppeur principal, testeur, ..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Ajouter l'utilisateur</button>
            </form>
        </div>
    </div>

    <!-- Modal: Edit Webhook -->
    <div id="editWebhookModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Modifier le webhook principal</h2>
                <button class="close-btn" onclick="closeModal('editWebhookModal')">&times;</button>
            </div>
            <form id="editWebhookForm">
                <div class="form-group">
                    <label>URL du webhook *</label>
                    <input type="url" id="main-webhook-url" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="webhook-description" rows="2">Webhook Discord principal pour les visiteurs non identifi√©s</textarea>
                </div>
                <button type="submit" class="btn btn-primary">Enregistrer</button>
            </form>
        </div>
    </div>

    <!-- Modal: View Session Details -->
    <div id="sessionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>D√©tails de la session</h2>
                <button class="close-btn" onclick="closeModal('sessionModal')">&times;</button>
            </div>
            <div id="session-details">
                <div class="loading">Chargement...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        // Configuration Supabase (√† adapter selon votre config)
        const SUPABASE_URL = 'https://apwhdqpdugvhwdvjlbee.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_U4b6xa4sBwEEs1heHmcEGg_M7MA5sB1';
        
        let supabase;

        // Initialisation
        async function init() {
            // Attendre que EchoDB soit disponible depuis la page parent
            if (window.EchoDB) {
                supabase = window.EchoDB.supabase;
            } else {
                // Fallback: cr√©er une instance Supabase
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }

            await loadStats();
            await loadWebhookConfig();
            await loadTrackedUsers();
            await loadRecentSessions();

            console.log('‚úÖ Admin panel initialized');
        }

        // Charger les statistiques
        async function loadStats() {
            try {
                const [users, sessions, events, webhooks] = await Promise.all([
                    supabase.from('tracked_users').select('id', { count: 'exact', head: true }),
                    supabase.from('user_sessions').select('id', { count: 'exact', head: true }),
                    supabase.from('tracking_events').select('id', { count: 'exact', head: true }),
                    supabase.from('webhook_settings').select('id', { count: 'exact', head: true })
                ]);

                document.getElementById('stat-users').textContent = users.count || 0;
                document.getElementById('stat-sessions').textContent = sessions.count || 0;
                document.getElementById('stat-events').textContent = events.count || 0;
                document.getElementById('stat-webhooks').textContent = webhooks.count || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Charger la config webhook
        async function loadWebhookConfig() {
            try {
                const { data, error } = await supabase
                    .from('webhook_settings')
                    .select('*')
                    .eq('setting_key', 'main_webhook')
                    .single();

                if (error) throw error;

                const container = document.getElementById('webhook-config');
                container.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div style="flex: 1;">
                            <p><strong>URL:</strong> <code>${maskWebhook(data.webhook_url)}</code></p>
                            <p><strong>Description:</strong> ${data.description || 'N/A'}</p>
                            <p><strong>Statut:</strong> 
                                <span class="badge ${data.is_active ? 'badge-success' : 'badge-warning'}">
                                    ${data.is_active ? 'Actif' : 'Inactif'}
                                </span>
                            </p>
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="editWebhook('${data.id}', '${data.webhook_url}', '${data.description}')">
                                Modifier
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading webhook:', error);
                document.getElementById('webhook-config').innerHTML = 
                    '<div class="empty-state">‚ùå Erreur de chargement</div>';
            }
        }

        // Masquer partiellement le webhook
        function maskWebhook(url) {
            if (!url) return 'Non configur√©';
            const parts = url.split('/');
            if (parts.length >= 2) {
                const token = parts[parts.length - 1];
                return url.replace(token, token.substring(0, 10) + '...' + token.substring(token.length - 5));
            }
            return url;
        }

        // Charger les utilisateurs track√©s
        async function loadTrackedUsers() {
            try {
                const { data, error } = await supabase
                    .from('tracked_users_stats')
                    .select('*')
                    .order('total_visits', { ascending: false });

                if (error) throw error;

                const container = document.getElementById('tracked-users');

                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div style="font-size: 64px; margin-bottom: 20px;">üë§</div>
                            <p>Aucun utilisateur track√©</p>
                            <p style="font-size: 14px; color: #999;">Ajoutez des utilisateurs pour suivre leur activit√© en d√©tail</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Pr√©nom</th>
                                <th>IP</th>
                                <th>Visites</th>
                                <th>Sessions</th>
                                <th>√âv√©nements</th>
                                <th>Temps Total</th>
                                <th>Derni√®re Visite</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(user => `
                                <tr>
                                    <td><strong>${user.first_name}</strong></td>
                                    <td><code>${user.ip_address}</code></td>
                                    <td>${user.total_visits}</td>
                                    <td>${user.session_count || 0}</td>
                                    <td>${user.total_events || 0}</td>
                                    <td>${formatDuration(user.total_time_seconds)}</td>
                                    <td>${formatDate(user.last_visit)}</td>
                                    <td>
                                        <div class="actions">
                                            <button class="btn btn-primary btn-sm" onclick="viewUserDetails('${user.id}')">
                                                üëÅÔ∏è
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading tracked users:', error);
                document.getElementById('tracked-users').innerHTML = 
                    '<div class="empty-state">‚ùå Erreur de chargement</div>';
            }
        }

        // Charger les sessions r√©centes
        async function loadRecentSessions() {
            try {
                const { data, error } = await supabase
                    .from('user_sessions')
                    .select(`
                        *,
                        tracked_user:tracked_users(first_name)
                    `)
                    .order('started_at', { ascending: false })
                    .limit(20);

                if (error) throw error;

                const container = document.getElementById('recent-sessions');

                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="empty-state">Aucune session r√©cente</div>';
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>IP</th>
                                <th>Page</th>
                                <th>Device</th>
                                <th>D√©but</th>
                                <th>Dur√©e</th>
                                <th>√âv√©nements</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(session => `
                                <tr>
                                    <td>
                                        ${session.tracked_user 
                                            ? `<strong>${session.tracked_user.first_name}</strong>` 
                                            : '<span style="color:#999;">Inconnu</span>'}
                                    </td>
                                    <td><code>${session.ip_address}</code></td>
                                    <td>${session.page}</td>
                                    <td>${session.device || 'N/A'}</td>
                                    <td>${formatDate(session.started_at)}</td>
                                    <td>${session.duration_seconds ? formatDuration(session.duration_seconds) : 'En cours'}</td>
                                    <td>${session.events_count || 0}</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="viewSession('${session.id}')">
                                            D√©tails
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading sessions:', error);
                document.getElementById('recent-sessions').innerHTML = 
                    '<div class="empty-state">‚ùå Erreur de chargement</div>';
            }
        }

        // Voir les d√©tails d'une session
        window.viewSession = async function(sessionId) {
            const modal = document.getElementById('sessionModal');
            const details = document.getElementById('session-details');
            
            modal.classList.add('active');
            details.innerHTML = '<div class="loading">Chargement...</div>';

            try {
                // Charger la session
                const { data: session, error: sessionError } = await supabase
                    .from('user_sessions')
                    .select(`
                        *,
                        tracked_user:tracked_users(first_name, ip_address)
                    `)
                    .eq('id', sessionId)
                    .single();

                if (sessionError) throw sessionError;

                // Charger les √©v√©nements
                const { data: events, error: eventsError } = await supabase
                    .from('tracking_events')
                    .select('*')
                    .eq('session_id', sessionId)
                    .order('created_at', { ascending: true });

                if (eventsError) throw eventsError;

                // Grouper les √©v√©nements par type
                const eventsByType = events.reduce((acc, evt) => {
                    if (!acc[evt.event_type]) acc[evt.event_type] = [];
                    acc[evt.event_type].push(evt);
                    return acc;
                }, {});

                details.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3>Informations de session</h3>
                        <p><strong>Utilisateur:</strong> ${session.tracked_user?.first_name || 'Inconnu'}</p>
                        <p><strong>IP:</strong> <code>${session.ip_address}</code></p>
                        <p><strong>Page:</strong> ${session.page}</p>
                        <p><strong>Device:</strong> ${session.device}</p>
                        <p><strong>Navigateur:</strong> ${session.browser}</p>
                        <p><strong>Localisation:</strong> ${session.location || 'N/A'}</p>
                        <p><strong>Dur√©e:</strong> ${session.duration_seconds ? formatDuration(session.duration_seconds) : 'En cours'}</p>
                        <p><strong>√âv√©nements totaux:</strong> ${events.length}</p>
                    </div>

                    <div>
                        <h3>√âv√©nements par type</h3>
                        ${Object.entries(eventsByType).map(([type, evts]) => `
                            <details style="margin-bottom: 10px;">
                                <summary style="cursor: pointer; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                                    <strong>${type}</strong> (${evts.length}x)
                                </summary>
                                <div style="padding: 10px; max-height: 200px; overflow-y: auto;">
                                    ${evts.map(evt => `
                                        <div style="padding: 5px; border-bottom: 1px solid #eee; font-size: 12px;">
                                            <code>${JSON.stringify(evt.event_data, null, 2)}</code>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading session details:', error);
                details.innerHTML = '<div class="empty-state">‚ùå Erreur de chargement</div>';
            }
        };

        // Ajouter un utilisateur
        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const ip = document.getElementById('user-ip').value;
            const name = document.getElementById('user-name').value;
            const webhook = document.getElementById('user-webhook').value;
            const notes = document.getElementById('user-notes').value;

            try {
                const { error } = await supabase
                    .from('tracked_users')
                    .insert({
                        ip_address: ip,
                        first_name: name,
                        webhook_url: webhook,
                        notes: notes || null
                    });

                if (error) throw error;

                alert('‚úÖ Utilisateur ajout√© avec succ√®s !');
                closeModal('addUserModal');
                loadTrackedUsers();
                loadStats();
                document.getElementById('addUserForm').reset();
            } catch (error) {
                console.error('Error adding user:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        });

        // Modifier le webhook principal
        document.getElementById('editWebhookForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const url = document.getElementById('main-webhook-url').value;
            const description = document.getElementById('webhook-description').value;

            try {
                const { error } = await supabase
                    .from('webhook_settings')
                    .update({
                        webhook_url: url,
                        description: description
                    })
                    .eq('setting_key', 'main_webhook');

                if (error) throw error;

                alert('‚úÖ Webhook mis √† jour avec succ√®s !');
                closeModal('editWebhookModal');
                loadWebhookConfig();
            } catch (error) {
                console.error('Error updating webhook:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        });

        // Supprimer un utilisateur
        window.deleteUser = async function(userId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet utilisateur ?')) return;

            try {
                const { error } = await supabase
                    .from('tracked_users')
                    .delete()
                    .eq('id', userId);

                if (error) throw error;

                alert('‚úÖ Utilisateur supprim√©');
                loadTrackedUsers();
                loadStats();
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        };

        // Modifier le webhook
        window.editWebhook = function(id, url, description) {
            document.getElementById('main-webhook-url').value = url;
            document.getElementById('webhook-description').value = description;
            document.getElementById('editWebhookModal').classList.add('active');
        };

        // Ouvrir modal ajout utilisateur
        window.openAddUserModal = function() {
            document.getElementById('addUserModal').classList.add('active');
        };

        // Fermer modal
        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
        };

        // Formater la dur√©e
        function formatDuration(seconds) {
            if (!seconds) return 'N/A';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}m ${secs}s`;
        }

        // Formater la date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Initialiser au chargement
        document.addEventListener('DOMContentLoaded', init);

        // Rafra√Æchir toutes les 30 secondes
        setInterval(() => {
            loadStats();
            loadRecentSessions();
        }, 30000);
    </script>
</body>
</html>